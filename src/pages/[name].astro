---
import BaseLayout from "../layout/BaseLayout.astro";
import NotFound from "./not-found.astro";
import ChannelDetails from "../components/ChannelDetails.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
const { params } = Astro;

export async function getStaticPaths() {
  // Replace this with real logic to get top channels or cached KV list
  const topChannels = ["mrbeast", "tseries", "5minutecrafts"];

  return topChannels.map((name) => ({
    params: { name: `${name}-net-worth` },
  }));
}

// 1. Remove "-net-worth" from the end to get clean name
const cleanName = (params.name ?? "").replace(/-net-worth$/, "");

// 2. Build full fetch URL to your Worker API
const apiUrl = `https://channelincome-backend.ytincome.workers.dev/?channel=@${cleanName}`;

// 3. Fetch channel data
let data: any = null;
let isError = false;

try {
  const response = await fetch(apiUrl);
  data = await response.json();
  isError = !response.ok || !data || !data.title;
} catch (err) {
  console.error("Failed to fetch channel data:", err);
  isError = true;
}

const pageTitle = `${data.title} YouTube Channel Income, Revenue & Earnings`;
const pageDescription = `Explore how much ${data.title} earns from YouTube ads. Up-to-date stats including views, subscribers, and revenue.`;
const pageUrl = `https://ytincomecalculator.pages.dev/${params.name}`;
const pageImage = data.thumbnail || "/default-og-image.png";
---

<BaseLayout
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  pageUrl={pageUrl}
  pageImage={pageImage}
>
  <Header />
  {
    isError ? (
      <>
        <NotFound />
      </>
    ) : (
      <>
        <ChannelDetails data={data} />
      </>
    )
  }
  <Footer />
</BaseLayout>
